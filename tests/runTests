#!/usr/bin/perl -w

use File::Compare;

$temp = "tempresults";
unlink $temp if(-e $temp);

@queries = <queries/*.qry>;
for $f (@queries) {
    #Remove "queries/" prefix 
    $f =~ s@[^/]*/@@;
    # Don't run the test if we don't know the expected results!
    next unless (-e "expected/$f.result");
    print "$f", (' ' x (32 - length($f)));

    open(TEMP, "> $temp") or die "Can't open $temp for writing!\n";
    open(CLIENT, "../demo/client/runSimple -silent -qf queries/$f 2>&1 |")
    	or die "Can't run client!\n";
    print TEMP while (<CLIENT>);
    close TEMP;
    $diffs = compare("expected/$f.result", "$temp");
    if ($diffs != 0) {
        print " FAILED\n";
        system "diff expected/$f.result $temp";
    } else {
        print " OK\n";
    }
}
